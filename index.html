<script>
  const API_URL = "https://tarefas-4hbd.onrender.com"; // sem /home

  function mostrarAlerta(mensagem) {
    const alerta = document.getElementById("alerta");
    alerta.innerText = mensagem;
    alerta.style.display = "block";

    setTimeout(() => {
      alerta.style.display = "none";
    }, 3000);
  }

  document.getElementById("btnSalvar").addEventListener("click", async () => {
    const tarefa = document.getElementById("tarefa").value.trim();
    const categoria = document.getElementById("categoria").value;

    if (!tarefa) {
      alert("Digite uma tarefa!");
      return;
    }

    try {
      const resposta = await fetch(`${API_URL}/tarefa`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ tarefa, categoria })
      });

      if (!resposta.ok) throw new Error("Erro ao salvar tarefa");

      document.getElementById("tarefa").value = "";
      mostrarAlerta("✅ Tarefa salva com sucesso!");

      setTimeout(() => baixarTarefas(), 300);
    } catch (err) {
      console.error("Erro:", err);
      alert("Erro ao salvar tarefa. Veja o console.");
    }
  });

  async function baixarTarefas() {
    try {
      const resposta = await fetch(`${API_URL}/tarefas`);
      const tarefas = await resposta.json();

      const ol = document.getElementById("listaDeTarefas");
      ol.innerHTML = "";

      tarefas.forEach((item) => {
        const li = document.createElement("li");

        // Usa fuso horário de Brasília corretamente
        const data = new Date(item.criado_em + "Z");
        const dataFormatada = data.toLocaleString("pt-BR", {
          timeZone: "America/Sao_Paulo"
        });

        li.innerHTML = `
          <div class="tarefa-topo">
            ${item.categoria === "casa" ? "🏠" : "💻"}
            <button onclick="excluirTarefa(${item.id})">Excluir</button>
          </div>
          <span>${item.tarefa}</span>
          <small>🕒 ${dataFormatada}</small>
        `;

        ol.appendChild(li);
      });
    } catch (err) {
      console.error("Erro ao buscar tarefas:", err);
    }
  }

  async function excluirTarefa(id) {
    try {
      const resposta = await fetch(`${API_URL}/tarefa/${id}`, {
        method: "DELETE"
      });

      if (!resposta.ok) throw new Error("Erro ao excluir tarefa");

      mostrarAlerta("🗑️ Tarefa excluída!");

      setTimeout(() => baixarTarefas(), 300);
    } catch (err) {
      console.error("Erro ao excluir:", err);
      alert("Erro ao excluir tarefa. Veja o console.");
    }
  }

  setInterval(() => {
    fetch("https://tarefas-4hbd.onrender.com/ping")
      .then(() => console.log("🔁 Ping enviado com sucesso"))
      .catch((error) => console.log("Erro ao enviar ping:", error));
  }, 30 * 60 * 1000);

  baixarTarefas();
</script>
